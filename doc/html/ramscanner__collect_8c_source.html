<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Ramscanner: ramscanner_collect.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Ramscanner</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>ramscanner_collect.c</h1>  </div>
</div>
<div class="contents">
<a href="ramscanner__collect_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00003"></a>00003 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00004"></a>00004 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00005"></a>00005 
<a name="l00006"></a>00006 <span class="preprocessor">#include &quot;<a class="code" href="ramscanner__collect_8h.html">ramscanner_collect.h</a>&quot;</span>
<a name="l00007"></a>00007 
<a name="l00033"></a>00033 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00034"></a><a class="code" href="ramscanner__collect_8c.html#acdce25f682f7cc424909fbabf5f005db">00034</a> <a class="code" href="ramscanner__collect_8c.html#acdce25f682f7cc424909fbabf5f005db">parse_smaps_file</a>(FILE *file, <a class="code" href="structsizestats.html">sizestats</a> *stats)
<a name="l00035"></a>00035 {
<a name="l00036"></a>00036         <span class="keywordtype">char</span> buffer[BUFSIZ];
<a name="l00037"></a>00037         <span class="keywordtype">char</span> *pt = buffer;
<a name="l00038"></a>00038         <span class="keywordtype">char</span> *pos = NULL;
<a name="l00039"></a>00039         <span class="keywordtype">size_t</span> n = 0;
<a name="l00040"></a>00040         uint32_t temp;
<a name="l00041"></a>00041         uint32_t arg1;
<a name="l00042"></a>00042         uint32_t arg2;
<a name="l00043"></a>00043         <span class="keywordflow">while</span> (getline(&amp;pt, &amp;n, file) &gt; 0) {
<a name="l00044"></a>00044                 <span class="keywordflow">if</span> (sscanf(pt, <span class="stringliteral">&quot;%x-%x&quot;</span>, &amp;arg1, &amp;arg2) == 2) {
<a name="l00045"></a>00045                         <span class="comment">/* First line of a vma detected, do nothing. */</span>
<a name="l00046"></a>00046                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strstr(pt, <a class="code" href="ramscanner__literals_8h.html#a8b194f7ae0da739da8b347978eb39e8b">SMAPS_VSS</a>) != NULL) {
<a name="l00047"></a>00047                         pos = strchr(pt, <span class="charliteral">&#39;:&#39;</span>);
<a name="l00048"></a>00048                         sscanf(pos + 1, <span class="stringliteral">&quot;%d kB&quot;</span>, &amp;temp);
<a name="l00049"></a>00049                         stats-&gt;<a class="code" href="structsizestats.html#a989f65215df751197aecf56514113e17">vss</a> += temp;
<a name="l00050"></a>00050                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strstr(pt, <a class="code" href="ramscanner__literals_8h.html#a6b97c95be256ab1b46c18d6eea610888">SMAPS_RSS</a>) != NULL) {
<a name="l00051"></a>00051                         pos = strchr(pt, <span class="charliteral">&#39;:&#39;</span>);
<a name="l00052"></a>00052                         sscanf(pos + 1, <span class="stringliteral">&quot;%d kB&quot;</span>, &amp;temp);
<a name="l00053"></a>00053                         stats-&gt;<a class="code" href="structsizestats.html#a25e117298413f3466bf12fd26a120029">rss</a> += temp;
<a name="l00054"></a>00054                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strstr(pt, <a class="code" href="ramscanner__literals_8h.html#a45219167350ee090f722a60328b89677">SMAPS_PSS</a>) != NULL) {
<a name="l00055"></a>00055                         pos = strchr(pt, <span class="charliteral">&#39;:&#39;</span>);
<a name="l00056"></a>00056                         sscanf(pos + 1, <span class="stringliteral">&quot;%d kB&quot;</span>, &amp;temp);
<a name="l00057"></a>00057                         stats-&gt;<a class="code" href="structsizestats.html#aec1ab10d6afc1baa8e469cfb5ef28776">pss</a> += temp;
<a name="l00058"></a>00058                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strstr(pt, <a class="code" href="ramscanner__literals_8h.html#a283cc9359327796df5277c781a9a8c45">SMAPS_REFD</a>) != NULL) {
<a name="l00059"></a>00059                         pos = strchr(pt, <span class="charliteral">&#39;:&#39;</span>);
<a name="l00060"></a>00060                         sscanf(pos + 1, <span class="stringliteral">&quot;%d kB&quot;</span>, &amp;temp);
<a name="l00061"></a>00061                         stats-&gt;<a class="code" href="structsizestats.html#a6069a72ada665f41a0d77ad96e50be0f">refd</a> += temp;
<a name="l00062"></a>00062                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strstr(pt, <a class="code" href="ramscanner__literals_8h.html#a4d9fdcb45dd6e9221f0003f6862c9471">SMAPS_ANON</a>) != NULL) {
<a name="l00063"></a>00063                         pos = strchr(pt, <span class="charliteral">&#39;:&#39;</span>);
<a name="l00064"></a>00064                         sscanf(pos + 1, <span class="stringliteral">&quot;%d kB&quot;</span>, &amp;temp);
<a name="l00065"></a>00065                         stats-&gt;<a class="code" href="structsizestats.html#a512e0892c179f51bc0670a4f91434ab0">anon</a> += temp;
<a name="l00066"></a>00066                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strstr(pt, <a class="code" href="ramscanner__literals_8h.html#a2d9cc1db38cbd5f19c3a93df1e426332">SMAPS_SWAP</a>) != NULL) {
<a name="l00067"></a>00067                         pos = strchr(pt, <span class="charliteral">&#39;:&#39;</span>);
<a name="l00068"></a>00068                         sscanf(pos + 1, <span class="stringliteral">&quot;%d kB&quot;</span>, &amp;temp);
<a name="l00069"></a>00069                         stats-&gt;<a class="code" href="structsizestats.html#a9b819f31c8c13244c6260492ba374948">swap</a> += temp;
<a name="l00070"></a>00070                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strstr(pt, <a class="code" href="ramscanner__literals_8h.html#a648475afb529ee27ba8d8e6e8aa8b7db">SMAPS_LOCKED</a>) != NULL) {
<a name="l00071"></a>00071                         pos = strchr(pt, <span class="charliteral">&#39;:&#39;</span>);
<a name="l00072"></a>00072                         sscanf(pos + 1, <span class="stringliteral">&quot;%d kB&quot;</span>, &amp;temp);
<a name="l00073"></a>00073                         stats-&gt;<a class="code" href="structsizestats.html#adebb5c2d09af509dc6196a96c8958646">locked</a> += temp;
<a name="l00074"></a>00074                 }
<a name="l00075"></a>00075         }
<a name="l00076"></a>00076 }
<a name="l00077"></a>00077 
<a name="l00083"></a>00083 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00084"></a><a class="code" href="ramscanner__collect_8c.html#afb500da45a8a85f07f223decbde00f22">00084</a> <a class="code" href="ramscanner__collect_8c.html#afb500da45a8a85f07f223decbde00f22">countgss</a>(<span class="keywordtype">void</span> *key, <span class="keywordtype">void</span> *value, <span class="keywordtype">void</span> *data)
<a name="l00085"></a>00085 {
<a name="l00086"></a>00086         <span class="keywordtype">size_t</span> pagesize = getpagesize();
<a name="l00087"></a>00087         <a class="code" href="structpagesummarydata.html">pagesummarydata</a> *page = value;
<a name="l00088"></a>00088         <a class="code" href="structsizestats.html">sizestats</a> *stats = data;
<a name="l00089"></a>00089         <span class="keywordflow">if</span> (page-&gt;<a class="code" href="structpagesummarydata.html#a1a2f3d1078136de046abbde0c345f797">memmapped</a> == page-&gt;<a class="code" href="structpagesummarydata.html#a5d3c0039dc383c052e40193e791bf591">procmapped</a>)
<a name="l00090"></a>00090                 stats-&gt;<a class="code" href="structsizestats.html#a3364cb7c6fd00d0dc379bffc43452fcc">gss</a> += pagesize/<a class="code" href="ramscanner__collect_8h.html#aa44bab413ffdffd5924758b448641ea3">KBSIZE</a>;
<a name="l00091"></a>00091 }
<a name="l00092"></a>00092 
<a name="l00098"></a>00098 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00099"></a><a class="code" href="ramscanner__collect_8c.html#a7b7e7a2bbf9bb7ac7ffea207dd67f048">00099</a> <a class="code" href="ramscanner__collect_8c.html#a7b7e7a2bbf9bb7ac7ffea207dd67f048">countsss</a>(<span class="keywordtype">void</span> *key, <span class="keywordtype">void</span> *value, <span class="keywordtype">void</span> *data)
<a name="l00100"></a>00100 {
<a name="l00101"></a>00101         <span class="keywordtype">size_t</span> pagesize = getpagesize();
<a name="l00102"></a>00102         <a class="code" href="structpagesummarydata.html">pagesummarydata</a> *page = value;
<a name="l00103"></a>00103         <a class="code" href="structsizestats.html">sizestats</a> *stats = data;
<a name="l00104"></a>00104         <span class="keywordflow">if</span> (page-&gt;<a class="code" href="structpagesummarydata.html#a1a2f3d1078136de046abbde0c345f797">memmapped</a> == page-&gt;<a class="code" href="structpagesummarydata.html#a5d3c0039dc383c052e40193e791bf591">procmapped</a>)
<a name="l00105"></a>00105                 stats-&gt;<a class="code" href="structsizestats.html#a8a30f664c67729abaf194e57d3c2a0ab">sss</a> += pagesize/<a class="code" href="ramscanner__collect_8h.html#aa44bab413ffdffd5924758b448641ea3">KBSIZE</a>;
<a name="l00106"></a>00106 }
<a name="l00107"></a>00107 
<a name="l00112"></a>00112 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00113"></a><a class="code" href="ramscanner__collect_8c.html#a51f3b3a2fe684b082ef2d5190a125df7">00113</a> <a class="code" href="ramscanner__collect_8c.html#a51f3b3a2fe684b082ef2d5190a125df7">lookup_smaps</a>(pid_t PID, <a class="code" href="structsizestats.html">sizestats</a> *stats)
<a name="l00114"></a>00114 {
<a name="l00115"></a>00115         <span class="keywordtype">char</span> buffer[BUFSIZ];
<a name="l00116"></a>00116         FILE *file;
<a name="l00117"></a>00117         <span class="keywordtype">int</span> ret;
<a name="l00118"></a>00118         sprintf(buffer, <span class="stringliteral">&quot;%s/%d/%s&quot;</span>, <a class="code" href="ramscanner__literals_8h.html#a149096b34cfc7cb6a5fefebcd953f4d5">PROC_PATH</a>, PID, <a class="code" href="ramscanner__literals_8h.html#a9962641fd63f927cdd74599ec3043490">SMAPS_FILENAME</a>);
<a name="l00119"></a>00119         errno = 0;
<a name="l00120"></a>00120         file = fopen(buffer, <span class="stringliteral">&quot;r&quot;</span>);
<a name="l00121"></a>00121         <span class="keywordflow">if</span> (file == NULL) {
<a name="l00122"></a>00122                 perror(<span class="stringliteral">&quot;Error opening smaps file&quot;</span>);
<a name="l00123"></a>00123                 <a class="code" href="ramscanner__common_8c.html#a9a3df3681470f93c9cbf201fb3e62795">cleanup_and_exit</a>(EXIT_FAILURE);
<a name="l00124"></a>00124         }
<a name="l00125"></a>00125         <a class="code" href="ramscanner__collect_8c.html#acdce25f682f7cc424909fbabf5f005db">parse_smaps_file</a>(file, stats);
<a name="l00126"></a>00126         errno = 0;
<a name="l00127"></a>00127         ret = fclose(file);
<a name="l00128"></a>00128         <span class="keywordflow">if</span> (ret != 0) {
<a name="l00129"></a>00129                 perror(<span class="stringliteral">&quot;Error closing smaps file&quot;</span>);
<a name="l00130"></a>00130                 errno = 0;
<a name="l00131"></a>00131         }
<a name="l00132"></a>00132 }
<a name="l00133"></a>00133 
<a name="l00138"></a>00138 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00139"></a><a class="code" href="ramscanner__collect_8c.html#afce862818e4b085e82ab08a9e3d75cfd">00139</a> <a class="code" href="ramscanner__collect_8c.html#afce862818e4b085e82ab08a9e3d75cfd">store_flags_in_page</a>(uint64_t bitfield, <a class="code" href="structpagedetaildata.html">pagedetaildata</a> *currentdpage)
<a name="l00140"></a>00140 {
<a name="l00141"></a>00141         currentdpage-&gt;<a class="code" href="structpagedetaildata.html#ab79ca79b587b4646615ae409c636aa90">locked</a>     = (bitfield &amp; <a class="code" href="ramscanner__collect_8h.html#a07cd878b96366299daba95a08c470ffd">PAGEFLAG_LOCKED</a>)     ? 1 : 0;
<a name="l00142"></a>00142         currentdpage-&gt;<a class="code" href="structpagedetaildata.html#a1aedae3537012074ad0e3ab7d093271e">referenced</a> = (bitfield &amp; <a class="code" href="ramscanner__collect_8h.html#a27318e549092ffbdeb35cb67a0aaad08">PAGEFLAG_REFERENCED</a>) ? 1 : 0;
<a name="l00143"></a>00143         currentdpage-&gt;<a class="code" href="structpagedetaildata.html#a194a712df4b4857b536603185f1630d2">dirty</a>      = (bitfield &amp; <a class="code" href="ramscanner__collect_8h.html#af0631f3ea8e405961f1252399f4c7ad7">PAGEFLAG_DIRTY</a>)      ? 1 : 0;
<a name="l00144"></a>00144         currentdpage-&gt;<a class="code" href="structpagedetaildata.html#a42cda287fd0972398739701653dde809">anonymous</a>  = (bitfield &amp; <a class="code" href="ramscanner__collect_8h.html#aacf9160b38efd8c5c2b6017982c8213a">PAGEFLAG_ANON</a>)       ? 1 : 0;
<a name="l00145"></a>00145         currentdpage-&gt;<a class="code" href="structpagedetaildata.html#aa066a464cadc63d63d64cc9372ea1658">swapcache</a>  = (bitfield &amp; <a class="code" href="ramscanner__collect_8h.html#afd5ead34440ee1d2ae740356896f43b4">PAGEFLAG_SWAPCACHE</a>)  ? 1 : 0;
<a name="l00146"></a>00146         currentdpage-&gt;<a class="code" href="structpagedetaildata.html#a3fe2eefda8955b201eaf9ddf9077243f">swapbacked</a> = (bitfield &amp; <a class="code" href="ramscanner__collect_8h.html#a471912274d4f2f4774e3ef459390aed3">PAGEFLAG_SWAPBACKED</a>) ? 1 : 0;
<a name="l00147"></a>00147         currentdpage-&gt;<a class="code" href="structpagedetaildata.html#a94233c04763e267acacd5116a443b2d6">ksm</a>        = (bitfield &amp; <a class="code" href="ramscanner__collect_8h.html#a0e66f18af6aebc6b2a13248c6a9cd28e">PAGEFLAG_KSM</a>)        ? 1 : 0;
<a name="l00148"></a>00148 
<a name="l00149"></a>00149 }
<a name="l00150"></a>00150 
<a name="l00163"></a>00163 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00164"></a><a class="code" href="ramscanner__collect_8c.html#ab0fccb96a9d60f7da5326e4616541227">00164</a> <a class="code" href="ramscanner__collect_8c.html#ab0fccb96a9d60f7da5326e4616541227">use_pfn</a>(uint64_t pfn, <a class="code" href="structoptions.html">options</a> *opt, FILE *filepageflags, FILE *filepagecount, 
<a name="l00165"></a>00165         <a class="code" href="structpagedetaildata.html">pagedetaildata</a> *currentdpage)
<a name="l00166"></a>00166 {
<a name="l00167"></a>00167         <span class="keywordtype">int</span> ret;
<a name="l00168"></a>00168         uint64_t bitfield;
<a name="l00169"></a>00169 
<a name="l00170"></a>00170         <span class="keywordtype">size_t</span> elementsize = <span class="keyword">sizeof</span>(uint64_t);
<a name="l00171"></a>00171         uint64_t index = pfn * elementsize;
<a name="l00172"></a>00172 
<a name="l00173"></a>00173         <a class="code" href="structpagesummarydata.html">pagesummarydata</a> *pData = NULL;
<a name="l00174"></a>00174         pData = g_hash_table_lookup(opt-&gt;<a class="code" href="structoptions.html#a3f12bfa404a3402c0506d8dc52da4c4c">summarypages</a>, &amp;pfn);
<a name="l00175"></a>00175 
<a name="l00176"></a>00176         <span class="keywordflow">if</span> (pData == NULL) {
<a name="l00177"></a>00177 
<a name="l00178"></a>00178         <span class="comment">/*</span>
<a name="l00179"></a>00179 <span class="comment">         * If the page is found in the about g_hash_table_lookup(), then it will</span>
<a name="l00180"></a>00180 <span class="comment">         * always increment the number of times the page has been mapped by a</span>
<a name="l00181"></a>00181 <span class="comment">         * process. If no page is found, then it checks to see if opt-&gt;summary,</span>
<a name="l00182"></a>00182 <span class="comment">         * opt-&gt;detail or opt-&gt;compactdetail exist. If this is not the case,</span>
<a name="l00183"></a>00183 <span class="comment">         * then it is checking if it is being mapped by a secondary process. If</span>
<a name="l00184"></a>00184 <span class="comment">         * it is a secondary process, then no extra pages will be added to</span>
<a name="l00185"></a>00185 <span class="comment">         * opt-&gt;summarypages.</span>
<a name="l00186"></a>00186 <span class="comment">         */</span>
<a name="l00187"></a>00187 
<a name="l00188"></a>00188                 <span class="keywordflow">if</span> (opt-&gt;<a class="code" href="structoptions.html#aa46b832c2b73ca872baee120bb4bc755">summary</a> || opt-&gt;<a class="code" href="structoptions.html#a57b3831a986f49e50f1746551d7c312e">detail</a> || opt-&gt;<a class="code" href="structoptions.html#aef87d29ef02ab135ff237eb2c7b9f9a7">compactdetail</a>) {
<a name="l00189"></a>00189                         errno = 0;
<a name="l00190"></a>00190                         pData = malloc(<span class="keyword">sizeof</span>(*pData));
<a name="l00191"></a>00191                         <span class="keywordflow">if</span> (pData == NULL) {
<a name="l00192"></a>00192                                 perror(<span class="stringliteral">&quot;Error allocating page summary data&quot;</span>);
<a name="l00193"></a>00193                                 <a class="code" href="ramscanner__common_8c.html#a9a3df3681470f93c9cbf201fb3e62795">cleanup_and_exit</a>(EXIT_FAILURE);
<a name="l00194"></a>00194                         }
<a name="l00195"></a>00195                         pData-&gt;<a class="code" href="structpagesummarydata.html#a5d3c0039dc383c052e40193e791bf591">procmapped</a> = 1;
<a name="l00196"></a>00196                         pData-&gt;<a class="code" href="structpagesummarydata.html#a1a2f3d1078136de046abbde0c345f797">memmapped</a> = 0; <span class="comment">/*Indicates a newly-mapped page*/</span>
<a name="l00197"></a>00197                         g_hash_table_insert(opt-&gt;<a class="code" href="structoptions.html#a3f12bfa404a3402c0506d8dc52da4c4c">summarypages</a>, <a class="code" href="ramscanner__common_8c.html#af9b4ea763f4ee48879a5efc735d079c5">newkey</a>(pfn), 
<a name="l00198"></a>00198                                             pData);
<a name="l00199"></a>00199                 }
<a name="l00200"></a>00200         } <span class="keywordflow">else</span> {
<a name="l00201"></a>00201                 pData-&gt;<a class="code" href="structpagesummarydata.html#a5d3c0039dc383c052e40193e791bf591">procmapped</a> += 1;
<a name="l00202"></a>00202         }
<a name="l00203"></a>00203 
<a name="l00204"></a>00204         <span class="keywordflow">if</span> (!(opt-&gt;<a class="code" href="structoptions.html#aa46b832c2b73ca872baee120bb4bc755">summary</a> || opt-&gt;<a class="code" href="structoptions.html#a57b3831a986f49e50f1746551d7c312e">detail</a> || opt-&gt;<a class="code" href="structoptions.html#aef87d29ef02ab135ff237eb2c7b9f9a7">compactdetail</a>))
<a name="l00205"></a>00205                 <span class="keywordflow">return</span>;
<a name="l00206"></a>00206 
<a name="l00207"></a>00207         errno = 0;
<a name="l00208"></a>00208         ret = fseek(filepagecount, index, SEEK_SET);
<a name="l00209"></a>00209         <span class="keywordflow">if</span> (ret == -1) {
<a name="l00210"></a>00210                 perror(<span class="stringliteral">&quot;Error seeking in kpagecount&quot;</span>);
<a name="l00211"></a>00211                 <a class="code" href="ramscanner__common_8c.html#a9a3df3681470f93c9cbf201fb3e62795">cleanup_and_exit</a>(EXIT_FAILURE);
<a name="l00212"></a>00212         }
<a name="l00213"></a>00213 
<a name="l00214"></a>00214         errno = 0;
<a name="l00215"></a>00215         ret = fread(&amp;bitfield, <span class="keyword">sizeof</span>(bitfield), 1, filepagecount);
<a name="l00216"></a>00216         <span class="keywordflow">if</span> (ret != 1) {
<a name="l00217"></a>00217                 perror(<span class="stringliteral">&quot;Error reading kpagecount&quot;</span>);
<a name="l00218"></a>00218                 <a class="code" href="ramscanner__common_8c.html#a9a3df3681470f93c9cbf201fb3e62795">cleanup_and_exit</a>(EXIT_FAILURE);
<a name="l00219"></a>00219         }
<a name="l00220"></a>00220 
<a name="l00221"></a>00221         <span class="keywordflow">if</span> (opt-&gt;<a class="code" href="structoptions.html#aa46b832c2b73ca872baee120bb4bc755">summary</a> &amp;&amp; (pData-&gt;<a class="code" href="structpagesummarydata.html#a1a2f3d1078136de046abbde0c345f797">memmapped</a> == 0)) {
<a name="l00222"></a>00222                 <span class="comment">/* This block of code is called only on a newly-mapped page. */</span>
<a name="l00223"></a>00223                 pData-&gt;<a class="code" href="structpagesummarydata.html#a1a2f3d1078136de046abbde0c345f797">memmapped</a> = bitfield;
<a name="l00224"></a>00224                 <span class="keywordflow">if</span> (bitfield == 1)
<a name="l00225"></a>00225                         opt-&gt;<a class="code" href="structoptions.html#a40fbf684316fd9e0819ab090506d3c19">summarystats</a>.<a class="code" href="structsizestats.html#a8aad02e33d374e9e238f204f8f7abc08">uss</a> += getpagesize()/<a class="code" href="ramscanner__collect_8h.html#aa44bab413ffdffd5924758b448641ea3">KBSIZE</a>;
<a name="l00226"></a>00226         }
<a name="l00227"></a>00227 
<a name="l00228"></a>00228         <span class="keywordflow">if</span> (!(opt-&gt;<a class="code" href="structoptions.html#a57b3831a986f49e50f1746551d7c312e">detail</a> || opt-&gt;<a class="code" href="structoptions.html#aef87d29ef02ab135ff237eb2c7b9f9a7">compactdetail</a>))
<a name="l00229"></a>00229                 <span class="keywordflow">return</span>;
<a name="l00230"></a>00230 
<a name="l00231"></a>00231         currentdpage-&gt;<a class="code" href="structpagedetaildata.html#a2301773722c04effa8e6a282a5a7242b">timesmapped</a> = bitfield;
<a name="l00232"></a>00232         errno = 0;
<a name="l00233"></a>00233         ret = fseek(filepageflags, index, SEEK_SET);
<a name="l00234"></a>00234         <span class="keywordflow">if</span> (ret == -1) {
<a name="l00235"></a>00235                 perror(<span class="stringliteral">&quot;Error seeking in kpageflags&quot;</span>);
<a name="l00236"></a>00236                 <a class="code" href="ramscanner__common_8c.html#a9a3df3681470f93c9cbf201fb3e62795">cleanup_and_exit</a>(EXIT_FAILURE);
<a name="l00237"></a>00237         }
<a name="l00238"></a>00238         errno = 0;
<a name="l00239"></a>00239         ret = fread(&amp;bitfield, <span class="keyword">sizeof</span>(bitfield), 1, filepageflags);
<a name="l00240"></a>00240         <span class="keywordflow">if</span> (ret != 1) {
<a name="l00241"></a>00241                 perror(<span class="stringliteral">&quot;Error reading kpageflags&quot;</span>);
<a name="l00242"></a>00242                 <a class="code" href="ramscanner__common_8c.html#a9a3df3681470f93c9cbf201fb3e62795">cleanup_and_exit</a>(EXIT_FAILURE);
<a name="l00243"></a>00243         }
<a name="l00244"></a>00244         <a class="code" href="ramscanner__collect_8c.html#afce862818e4b085e82ab08a9e3d75cfd">store_flags_in_page</a>(bitfield, currentdpage);
<a name="l00245"></a>00245 }
<a name="l00246"></a>00246 
<a name="l00253"></a>00253 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00254"></a><a class="code" href="ramscanner__collect_8c.html#aa002283ea1ba949cdd204719353732e1">00254</a> <a class="code" href="ramscanner__collect_8c.html#aa002283ea1ba949cdd204719353732e1">parse_bitfield</a>(uint64_t bitfield, <a class="code" href="structoptions.html">options</a> *opt, FILE *filepageflags, 
<a name="l00255"></a>00255                FILE *filepagecount, <a class="code" href="structpagedetaildata.html">pagedetaildata</a> *currentdpage)
<a name="l00256"></a>00256 {
<a name="l00257"></a>00257         uint64_t pfnbits;
<a name="l00258"></a>00258 
<a name="l00259"></a>00259         <span class="keywordflow">if</span> (opt-&gt;<a class="code" href="structoptions.html#a57b3831a986f49e50f1746551d7c312e">detail</a>) {
<a name="l00260"></a>00260                 uint64_t pageshift;
<a name="l00261"></a>00261 
<a name="l00262"></a>00262                 <span class="keywordflow">if</span> (bitfield &amp; <a class="code" href="ramscanner__collect_8h.html#a6fcc63835d2bc675ea31454fa7e0c8e8">PAGEPRESENT</a>) 
<a name="l00263"></a>00263                         currentdpage-&gt;<a class="code" href="structpagedetaildata.html#a036707143fb5b570d5a652f406140c0f">present</a> = 1;
<a name="l00264"></a>00264                 <span class="keywordflow">else</span>
<a name="l00265"></a>00265                         currentdpage-&gt;<a class="code" href="structpagedetaildata.html#a036707143fb5b570d5a652f406140c0f">present</a> = 0;
<a name="l00266"></a>00266                 pageshift = bitfield &amp; <a class="code" href="ramscanner__collect_8h.html#a5eebce4227cef68c34e40c9a47156f93">PAGESHIFTBITS</a>;
<a name="l00267"></a>00267                 pageshift = pageshift &gt;&gt; <a class="code" href="ramscanner__collect_8h.html#aaab0f5ef194d7ed0467560bcdc110588">PAGESHIFT</a>;
<a name="l00268"></a>00268                 currentdpage-&gt;<a class="code" href="structpagedetaildata.html#a22b602c3181c247f9763370ecffd707c">pageshift</a> = pageshift;
<a name="l00269"></a>00269         }
<a name="l00270"></a>00270         <span class="keywordflow">if</span> (bitfield &amp; <a class="code" href="ramscanner__collect_8h.html#a025d5ecf9a3bf5dba6829eed58cd667a">PAGESWAPPED</a>) {
<a name="l00271"></a>00271                 <span class="comment">/* Omitting swap type and swap offset information. */</span>
<a name="l00272"></a>00272                 <span class="keywordflow">if</span> (opt-&gt;<a class="code" href="structoptions.html#a57b3831a986f49e50f1746551d7c312e">detail</a>)
<a name="l00273"></a>00273                         currentdpage-&gt;<a class="code" href="structpagedetaildata.html#abf014a39240094609ea641ae130ca2f3">swap</a> = 1;
<a name="l00274"></a>00274                 <span class="keywordflow">return</span>;
<a name="l00275"></a>00275         }
<a name="l00276"></a>00276         <span class="keywordflow">if</span> (opt-&gt;<a class="code" href="structoptions.html#a57b3831a986f49e50f1746551d7c312e">detail</a>)
<a name="l00277"></a>00277                 currentdpage-&gt;<a class="code" href="structpagedetaildata.html#abf014a39240094609ea641ae130ca2f3">swap</a> = 0;
<a name="l00278"></a>00278         pfnbits = bitfield &amp; <a class="code" href="ramscanner__collect_8h.html#ad684cec3813f71ea66ce981dd058f08f">PFNBITS</a>;
<a name="l00279"></a>00279 
<a name="l00280"></a>00280         <span class="keywordflow">if</span> (opt-&gt;<a class="code" href="structoptions.html#a57b3831a986f49e50f1746551d7c312e">detail</a>)
<a name="l00281"></a>00281                 currentdpage-&gt;<a class="code" href="structpagedetaildata.html#a4ec963e2c6312e3a4573aa3f38c18341">pfn</a> = pfnbits;
<a name="l00282"></a>00282 
<a name="l00283"></a>00283         <a class="code" href="ramscanner__collect_8c.html#ab0fccb96a9d60f7da5326e4616541227">use_pfn</a>(pfnbits, opt, filepageflags, filepagecount, currentdpage);
<a name="l00284"></a>00284 }
<a name="l00285"></a>00285 
<a name="l00294"></a>00294 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00295"></a><a class="code" href="ramscanner__collect_8c.html#af9ea1162d4f7a57283dcdcf35be2bccd">00295</a> <a class="code" href="ramscanner__collect_8c.html#af9ea1162d4f7a57283dcdcf35be2bccd">are_pages_identical_and_adjacent</a>(<a class="code" href="structpagedetaildata.html">pagedetaildata</a> *prev, <a class="code" href="structpagedetaildata.html">pagedetaildata</a> *curr)
<a name="l00296"></a>00296 {
<a name="l00297"></a>00297         <span class="keywordflow">if</span> (prev == NULL)                           <span class="keywordflow">return</span> 0;
<a name="l00298"></a>00298         <span class="keywordflow">if</span> (prev-&gt;<a class="code" href="structpagedetaildata.html#a780c3a4bd914a2da49aafb7c99cc216a">addrend</a>     != curr-&gt;<a class="code" href="structpagedetaildata.html#a75c19d5792d61926ccc91eeec4c24026">addrstart</a>)   <span class="keywordflow">return</span> 0;
<a name="l00299"></a>00299         <span class="keywordflow">if</span> (prev-&gt;<a class="code" href="structpagedetaildata.html#af3eee3b51b1146030f02c43ad62e6d11">vmaindex</a>    != curr-&gt;<a class="code" href="structpagedetaildata.html#af3eee3b51b1146030f02c43ad62e6d11">vmaindex</a>)    <span class="keywordflow">return</span> 0;
<a name="l00300"></a>00300         <span class="keywordflow">if</span> (prev-&gt;<a class="code" href="structpagedetaildata.html#a036707143fb5b570d5a652f406140c0f">present</a>     != curr-&gt;<a class="code" href="structpagedetaildata.html#a036707143fb5b570d5a652f406140c0f">present</a>)     <span class="keywordflow">return</span> 0;
<a name="l00301"></a>00301         <span class="keywordflow">if</span> (prev-&gt;<a class="code" href="structpagedetaildata.html#a22b602c3181c247f9763370ecffd707c">pageshift</a>   != curr-&gt;<a class="code" href="structpagedetaildata.html#a22b602c3181c247f9763370ecffd707c">pageshift</a>)   <span class="keywordflow">return</span> 0;
<a name="l00302"></a>00302         <span class="keywordflow">if</span> (prev-&gt;<a class="code" href="structpagedetaildata.html#abf014a39240094609ea641ae130ca2f3">swap</a>        != curr-&gt;<a class="code" href="structpagedetaildata.html#abf014a39240094609ea641ae130ca2f3">swap</a>)        <span class="keywordflow">return</span> 0;
<a name="l00303"></a>00303         <span class="keywordflow">if</span> (prev-&gt;<a class="code" href="structpagedetaildata.html#a2301773722c04effa8e6a282a5a7242b">timesmapped</a> != curr-&gt;<a class="code" href="structpagedetaildata.html#a2301773722c04effa8e6a282a5a7242b">timesmapped</a>) <span class="keywordflow">return</span> 0;
<a name="l00304"></a>00304         <span class="keywordflow">if</span> (prev-&gt;<a class="code" href="structpagedetaildata.html#ab79ca79b587b4646615ae409c636aa90">locked</a>      != curr-&gt;<a class="code" href="structpagedetaildata.html#ab79ca79b587b4646615ae409c636aa90">locked</a>)      <span class="keywordflow">return</span> 0;
<a name="l00305"></a>00305         <span class="keywordflow">if</span> (prev-&gt;<a class="code" href="structpagedetaildata.html#a1aedae3537012074ad0e3ab7d093271e">referenced</a>  != curr-&gt;<a class="code" href="structpagedetaildata.html#a1aedae3537012074ad0e3ab7d093271e">referenced</a>)  <span class="keywordflow">return</span> 0;
<a name="l00306"></a>00306         <span class="keywordflow">if</span> (prev-&gt;<a class="code" href="structpagedetaildata.html#a194a712df4b4857b536603185f1630d2">dirty</a>       != curr-&gt;<a class="code" href="structpagedetaildata.html#a194a712df4b4857b536603185f1630d2">dirty</a>)       <span class="keywordflow">return</span> 0;
<a name="l00307"></a>00307         <span class="keywordflow">if</span> (prev-&gt;<a class="code" href="structpagedetaildata.html#a42cda287fd0972398739701653dde809">anonymous</a>   != curr-&gt;<a class="code" href="structpagedetaildata.html#a42cda287fd0972398739701653dde809">anonymous</a>)   <span class="keywordflow">return</span> 0;
<a name="l00308"></a>00308         <span class="keywordflow">if</span> (prev-&gt;<a class="code" href="structpagedetaildata.html#aa066a464cadc63d63d64cc9372ea1658">swapcache</a>   != curr-&gt;<a class="code" href="structpagedetaildata.html#aa066a464cadc63d63d64cc9372ea1658">swapcache</a>)   <span class="keywordflow">return</span> 0;
<a name="l00309"></a>00309         <span class="keywordflow">if</span> (prev-&gt;<a class="code" href="structpagedetaildata.html#a3fe2eefda8955b201eaf9ddf9077243f">swapbacked</a>  != curr-&gt;<a class="code" href="structpagedetaildata.html#a3fe2eefda8955b201eaf9ddf9077243f">swapbacked</a>)  <span class="keywordflow">return</span> 0;
<a name="l00310"></a>00310         <span class="keywordflow">if</span> (prev-&gt;<a class="code" href="structpagedetaildata.html#a94233c04763e267acacd5116a443b2d6">ksm</a>         != curr-&gt;<a class="code" href="structpagedetaildata.html#a94233c04763e267acacd5116a443b2d6">ksm</a>)         <span class="keywordflow">return</span> 0;
<a name="l00311"></a>00311         <span class="keywordflow">return</span> 1;
<a name="l00312"></a>00312         
<a name="l00313"></a>00313 }
<a name="l00314"></a>00314 
<a name="l00324"></a>00324 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00325"></a><a class="code" href="ramscanner__collect_8c.html#a50b3f0e53f509ce2e69f18fa1e61358c">00325</a> <a class="code" href="ramscanner__collect_8c.html#a50b3f0e53f509ce2e69f18fa1e61358c">lookup_pagemap_with_addresses</a>(uint32_t addressfrom, uint32_t addressto, 
<a name="l00326"></a>00326                               <a class="code" href="structoptions.html">options</a> *opt, FILE *filepageflags,
<a name="l00327"></a>00327                               FILE *filepagecount, FILE *filepagemap,
<a name="l00328"></a>00328                               uint16_t vmaindex)
<a name="l00329"></a>00329 {
<a name="l00330"></a>00330         <span class="keywordtype">size_t</span> entrysize = <span class="keyword">sizeof</span>(uint64_t);
<a name="l00331"></a>00331         <span class="keywordtype">size_t</span> pagesize = getpagesize();
<a name="l00332"></a>00332         <a class="code" href="structpagedetaildata.html">pagedetaildata</a> *previousdpage = NULL;
<a name="l00333"></a>00333         <a class="code" href="structpagedetaildata.html">pagedetaildata</a> *currentdpage;
<a name="l00334"></a>00334         errno = 0;
<a name="l00335"></a>00335         currentdpage = calloc(1, <span class="keyword">sizeof</span>(*currentdpage));
<a name="l00336"></a>00336         <span class="keywordflow">if</span> (currentdpage == NULL) {
<a name="l00337"></a>00337                 perror(<span class="stringliteral">&quot;Error occurred allocating memory for detail page&quot;</span>);
<a name="l00338"></a>00338                 <a class="code" href="ramscanner__common_8c.html#a9a3df3681470f93c9cbf201fb3e62795">cleanup_and_exit</a>(EXIT_FAILURE);
<a name="l00339"></a>00339         }
<a name="l00340"></a>00340 
<a name="l00341"></a>00341         uint32_t entryfrom = addressfrom / pagesize;
<a name="l00342"></a>00342         uint32_t entryto = addressto / pagesize;
<a name="l00343"></a>00343         <span class="comment">/* Multiplying and dividing done in separate steps because multiplying</span>
<a name="l00344"></a>00344 <span class="comment">         * address by entrysize often causes an overflow. </span>
<a name="l00345"></a>00345 <span class="comment">         */</span>
<a name="l00346"></a>00346         entryfrom *= entrysize;
<a name="l00347"></a>00347         entryto *= entrysize;
<a name="l00348"></a>00348 
<a name="l00349"></a>00349         uint32_t i;
<a name="l00350"></a>00350         
<a name="l00351"></a>00351         <span class="keywordflow">for</span> (i = entryfrom; i &lt; entryto; i += entrysize) {
<a name="l00352"></a>00352                 <span class="keywordtype">int</span> inum = i / entrysize;
<a name="l00353"></a>00353                 <span class="keywordtype">int</span> ret;
<a name="l00354"></a>00354                 uint64_t bitfield;
<a name="l00355"></a>00355                 uint32_t o;
<a name="l00356"></a>00356 
<a name="l00357"></a>00357                 errno = 0;
<a name="l00358"></a>00358                 o = fseek(filepagemap, i, SEEK_SET);
<a name="l00359"></a>00359                 <span class="keywordflow">if</span> (o == -1) {
<a name="l00360"></a>00360                         perror(<span class="stringliteral">&quot;Error seeking in pagemap&quot;</span>);
<a name="l00361"></a>00361                         <a class="code" href="ramscanner__common_8c.html#a9a3df3681470f93c9cbf201fb3e62795">cleanup_and_exit</a>(EXIT_FAILURE);
<a name="l00362"></a>00362                 }
<a name="l00363"></a>00363                 errno = 0;
<a name="l00364"></a>00364                 ret = fread(&amp;bitfield, <span class="keyword">sizeof</span>(bitfield), 1, filepagemap);
<a name="l00365"></a>00365                 <span class="keywordflow">if</span> (ret != 1) {
<a name="l00366"></a>00366                         perror(<span class="stringliteral">&quot;Error reading pagemap&quot;</span>);
<a name="l00367"></a>00367                         <a class="code" href="ramscanner__common_8c.html#a9a3df3681470f93c9cbf201fb3e62795">cleanup_and_exit</a>(EXIT_FAILURE);
<a name="l00368"></a>00368                 }
<a name="l00369"></a>00369 
<a name="l00370"></a>00370                 currentdpage-&gt;<a class="code" href="structpagedetaildata.html#af3eee3b51b1146030f02c43ad62e6d11">vmaindex</a> = vmaindex;
<a name="l00371"></a>00371                 currentdpage-&gt;<a class="code" href="structpagedetaildata.html#a75c19d5792d61926ccc91eeec4c24026">addrstart</a> = inum * pagesize;
<a name="l00372"></a>00372                 currentdpage-&gt;<a class="code" href="structpagedetaildata.html#a780c3a4bd914a2da49aafb7c99cc216a">addrend</a> = (inum + 1) * pagesize;
<a name="l00373"></a>00373 
<a name="l00374"></a>00374                 <a class="code" href="ramscanner__collect_8c.html#aa002283ea1ba949cdd204719353732e1">parse_bitfield</a>(bitfield, opt, 
<a name="l00375"></a>00375                                filepageflags, filepagecount, currentdpage);
<a name="l00376"></a>00376 
<a name="l00377"></a>00377                 <span class="keywordflow">if</span> (<a class="code" href="ramscanner__collect_8c.html#af9ea1162d4f7a57283dcdcf35be2bccd">are_pages_identical_and_adjacent</a>(previousdpage,
<a name="l00378"></a>00378                                                      currentdpage)) {
<a name="l00379"></a>00379                         previousdpage-&gt;<a class="code" href="structpagedetaildata.html#a780c3a4bd914a2da49aafb7c99cc216a">addrend</a> = currentdpage-&gt;<a class="code" href="structpagedetaildata.html#a780c3a4bd914a2da49aafb7c99cc216a">addrend</a>;
<a name="l00380"></a>00380                         memset(currentdpage, 0, <span class="keyword">sizeof</span>(*currentdpage));
<a name="l00381"></a>00381                 } <span class="keywordflow">else</span> {
<a name="l00382"></a>00382                         g_hash_table_insert(opt-&gt;<a class="code" href="structoptions.html#a3633157dccdfa6c34ba42b290f7cab34">detailpages</a>, 
<a name="l00383"></a>00383                                             <a class="code" href="ramscanner__common_8c.html#af9b4ea763f4ee48879a5efc735d079c5">newkey</a>(currentdpage-&gt;<a class="code" href="structpagedetaildata.html#a75c19d5792d61926ccc91eeec4c24026">addrstart</a>), 
<a name="l00384"></a>00384                                             currentdpage);
<a name="l00385"></a>00385                         previousdpage = currentdpage;
<a name="l00386"></a>00386                         errno = 0;
<a name="l00387"></a>00387                         currentdpage = calloc(1, <span class="keyword">sizeof</span>(*currentdpage));
<a name="l00388"></a>00388                         <span class="keywordflow">if</span> (currentdpage == NULL) {
<a name="l00389"></a>00389                                 perror(<span class="stringliteral">&quot;Error occurred allocating memory for&quot;</span>
<a name="l00390"></a>00390                                        <span class="stringliteral">&quot; detail page&quot;</span>);
<a name="l00391"></a>00391                                 <a class="code" href="ramscanner__common_8c.html#a9a3df3681470f93c9cbf201fb3e62795">cleanup_and_exit</a>(EXIT_FAILURE);
<a name="l00392"></a>00392                         }
<a name="l00393"></a>00393                 }
<a name="l00394"></a>00394         }
<a name="l00395"></a>00395 }
<a name="l00396"></a>00396 
<a name="l00405"></a>00405 <span class="keyword">static</span> <a class="code" href="structvmastats.html">vmastats</a> *
<a name="l00406"></a><a class="code" href="ramscanner__collect_8c.html#a712555ae6bff502a411333314d8b2b95">00406</a> <a class="code" href="ramscanner__collect_8c.html#a712555ae6bff502a411333314d8b2b95">make_another_vmst_in_opt</a>(<a class="code" href="structoptions.html">options</a> *opt)
<a name="l00407"></a>00407 {
<a name="l00408"></a>00408         <a class="code" href="structvmastats.html">vmastats</a> *temp;
<a name="l00409"></a>00409         <a class="code" href="structvmastats.html">vmastats</a> *newelement;
<a name="l00410"></a>00410         errno = 0;
<a name="l00411"></a>00411         temp = realloc(opt-&gt;<a class="code" href="structoptions.html#a694f66a9718a83a7948aeba212945e4f">vmas</a>, <span class="keyword">sizeof</span>(*temp) * (opt-&gt;<a class="code" href="structoptions.html#a70a839c12fbd2059a75cda3b8af76085">vmacount</a> + 1));
<a name="l00412"></a>00412         <span class="keywordflow">if</span> (temp == NULL) {
<a name="l00413"></a>00413                 perror(<span class="stringliteral">&quot;Error allocating new vmastats&quot;</span>);
<a name="l00414"></a>00414                 <a class="code" href="ramscanner__common_8c.html#a9a3df3681470f93c9cbf201fb3e62795">cleanup_and_exit</a>(EXIT_FAILURE);
<a name="l00415"></a>00415         }
<a name="l00416"></a>00416         opt-&gt;<a class="code" href="structoptions.html#a694f66a9718a83a7948aeba212945e4f">vmas</a> = temp;
<a name="l00417"></a>00417         (opt-&gt;<a class="code" href="structoptions.html#a70a839c12fbd2059a75cda3b8af76085">vmacount</a>)++;
<a name="l00418"></a>00418         newelement = &amp;(temp[opt-&gt;<a class="code" href="structoptions.html#a70a839c12fbd2059a75cda3b8af76085">vmacount</a> - 1]);
<a name="l00419"></a>00419         memset(newelement, 0, <span class="keyword">sizeof</span>(*newelement));
<a name="l00420"></a>00420         <span class="keywordflow">return</span> newelement;
<a name="l00421"></a>00421 }
<a name="l00422"></a>00422 
<a name="l00431"></a>00431 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00432"></a><a class="code" href="ramscanner__collect_8c.html#abffda3486ef70acf1cd5492c3eaf585f">00432</a> <a class="code" href="ramscanner__collect_8c.html#abffda3486ef70acf1cd5492c3eaf585f">lookup_maps_with_PID</a>(pid_t pid, <a class="code" href="structoptions.html">options</a> *opt, FILE *filepageflags, 
<a name="l00433"></a>00433                      FILE *filepagecount)
<a name="l00434"></a>00434 {
<a name="l00435"></a>00435         <span class="keywordtype">char</span> pathbuf[PATH_MAX];
<a name="l00436"></a>00436         <span class="keywordtype">char</span> buffer[BUFSIZ]; <span class="comment">/* Buffer for storing lines read from file*/</span>
<a name="l00437"></a>00437         FILE *filemaps;
<a name="l00438"></a>00438         FILE *filepagemap;
<a name="l00439"></a>00439         <span class="keywordtype">int</span> ret;
<a name="l00440"></a>00440         <span class="keywordtype">char</span> *pos = NULL;
<a name="l00441"></a>00441 
<a name="l00442"></a>00442         sprintf(pathbuf, <span class="stringliteral">&quot;%s/%u/%s&quot;</span>, <a class="code" href="ramscanner__literals_8h.html#a149096b34cfc7cb6a5fefebcd953f4d5">PROC_PATH</a>, pid, <a class="code" href="ramscanner__literals_8h.html#a208031be13c7a171d84335a87ae48a99">MAPS_FILENAME</a>);
<a name="l00443"></a>00443         errno = 0;
<a name="l00444"></a>00444         filemaps = fopen(pathbuf, <span class="stringliteral">&quot;r&quot;</span>);
<a name="l00445"></a>00445         <span class="keywordflow">if</span> (filemaps == NULL) {
<a name="l00446"></a>00446                 perror(<span class="stringliteral">&quot;Error opening maps file&quot;</span>);
<a name="l00447"></a>00447                 <a class="code" href="ramscanner__common_8c.html#a9a3df3681470f93c9cbf201fb3e62795">cleanup_and_exit</a>(EXIT_FAILURE);
<a name="l00448"></a>00448         }
<a name="l00449"></a>00449 
<a name="l00450"></a>00450         sprintf(pathbuf, <span class="stringliteral">&quot;%s/%u/%s&quot;</span>, <a class="code" href="ramscanner__literals_8h.html#a149096b34cfc7cb6a5fefebcd953f4d5">PROC_PATH</a>, pid, <a class="code" href="ramscanner__literals_8h.html#a39185a5d660b39b08c3c4debd4b73b97">PAGEMAP_FILENAME</a>);
<a name="l00451"></a>00451         errno = 0;
<a name="l00452"></a>00452         filepagemap = fopen(pathbuf, <span class="stringliteral">&quot;r&quot;</span>);
<a name="l00453"></a>00453         <span class="keywordflow">if</span> (filepagemap == NULL) {
<a name="l00454"></a>00454                 perror(<span class="stringliteral">&quot;Error opening pagemap file&quot;</span>);
<a name="l00455"></a>00455                 <a class="code" href="ramscanner__common_8c.html#a9a3df3681470f93c9cbf201fb3e62795">cleanup_and_exit</a>(EXIT_FAILURE);
<a name="l00456"></a>00456         }
<a name="l00457"></a>00457 
<a name="l00458"></a>00458         <span class="keywordflow">while</span> (fgets(buffer, BUFSIZ, filemaps) != NULL) {
<a name="l00459"></a>00459                 <a class="code" href="structvmastats.html">vmastats</a> *vmst = <a class="code" href="ramscanner__collect_8c.html#a712555ae6bff502a411333314d8b2b95">make_another_vmst_in_opt</a>(opt);
<a name="l00460"></a>00460                 uint16_t vmaindex = opt-&gt;<a class="code" href="structoptions.html#a70a839c12fbd2059a75cda3b8af76085">vmacount</a> - 1;
<a name="l00461"></a>00461                 uint32_t addrstart;
<a name="l00462"></a>00462                 uint32_t addrend;
<a name="l00463"></a>00463 
<a name="l00464"></a>00464                 errno = 0;
<a name="l00465"></a>00465                 ret = sscanf(buffer, <span class="stringliteral">&quot;%x-%x %4s&quot;</span>, &amp;addrstart, &amp;addrend,
<a name="l00466"></a>00466                              vmst-&gt;<a class="code" href="structvmastats.html#aacf49798007b530efd7a49e051d20c54">permissions</a>);
<a name="l00467"></a>00467                 <span class="keywordflow">if</span> (ret == EOF &amp;&amp; errno != 0) {
<a name="l00468"></a>00468                         perror(<span class="stringliteral">&quot;Error parsing addresses from a line of maps&quot;</span>
<a name="l00469"></a>00469                                <span class="stringliteral">&quot; file&quot;</span>);
<a name="l00470"></a>00470                         <a class="code" href="ramscanner__common_8c.html#a9a3df3681470f93c9cbf201fb3e62795">cleanup_and_exit</a>(EXIT_FAILURE);
<a name="l00471"></a>00471                 }
<a name="l00472"></a>00472 
<a name="l00473"></a>00473                 <span class="keywordflow">if</span> (ret &lt; 3){
<a name="l00474"></a>00474                         fprintf(stderr, <span class="stringliteral">&quot;Error: Unexpected format of line in&quot;</span>
<a name="l00475"></a>00475                                         <span class="stringliteral">&quot;maps.\n&quot;</span>);
<a name="l00476"></a>00476                         <a class="code" href="ramscanner__common_8c.html#a9a3df3681470f93c9cbf201fb3e62795">cleanup_and_exit</a>(EXIT_FAILURE);
<a name="l00477"></a>00477                 }
<a name="l00478"></a>00478 
<a name="l00479"></a>00479                 <span class="keywordflow">if</span> ((pos = strchr(buffer, <span class="charliteral">&#39;/&#39;</span>)) != NULL) {
<a name="l00480"></a>00480                         <span class="keywordtype">char</span> *newlinepos;
<a name="l00481"></a>00481                         strcpy(vmst-&gt;<a class="code" href="structvmastats.html#ab3204e1620ba49d665203a91c6af5fd8">path</a>, pos);
<a name="l00482"></a>00482                         newlinepos = strrchr(vmst-&gt;<a class="code" href="structvmastats.html#ab3204e1620ba49d665203a91c6af5fd8">path</a>, <span class="charliteral">&#39;\n&#39;</span>);
<a name="l00483"></a>00483                         *newlinepos = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00484"></a>00484                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pos = strchr(buffer, <span class="charliteral">&#39;[&#39;</span>)) != NULL) {
<a name="l00485"></a>00485                         <span class="keywordtype">char</span> *newlinepos;
<a name="l00486"></a>00486                         strcpy(vmst-&gt;<a class="code" href="structvmastats.html#ab3204e1620ba49d665203a91c6af5fd8">path</a>, pos);
<a name="l00487"></a>00487                         newlinepos = strrchr(vmst-&gt;<a class="code" href="structvmastats.html#ab3204e1620ba49d665203a91c6af5fd8">path</a>, <span class="charliteral">&#39;\n&#39;</span>);
<a name="l00488"></a>00488                         *newlinepos = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00489"></a>00489                 }
<a name="l00490"></a>00490 
<a name="l00491"></a>00491                 <a class="code" href="ramscanner__collect_8c.html#a50b3f0e53f509ce2e69f18fa1e61358c">lookup_pagemap_with_addresses</a>(addrstart, 
<a name="l00492"></a>00492                                               addrend, opt,
<a name="l00493"></a>00493                                               filepageflags, filepagecount,
<a name="l00494"></a>00494                                               filepagemap, vmaindex);
<a name="l00495"></a>00495         }
<a name="l00496"></a>00496 
<a name="l00497"></a>00497         errno = 0;
<a name="l00498"></a>00498         ret = fclose(filemaps);
<a name="l00499"></a>00499         <span class="keywordflow">if</span> (ret == EOF) {
<a name="l00500"></a>00500                 perror(<span class="stringliteral">&quot;Error closing maps file&quot;</span>);
<a name="l00501"></a>00501                 errno = 0;
<a name="l00502"></a>00502         }
<a name="l00503"></a>00503         errno = 0;
<a name="l00504"></a>00504         ret = fclose(filepagemap);
<a name="l00505"></a>00505         <span class="keywordflow">if</span> (ret == EOF) {
<a name="l00506"></a>00506                 perror(<span class="stringliteral">&quot;Error closing pagemap file&quot;</span>);
<a name="l00507"></a>00507                 errno = 0;
<a name="l00508"></a>00508         }
<a name="l00509"></a>00509 }
<a name="l00510"></a>00510 
<a name="l00517"></a>00517 <span class="keywordtype">void</span>
<a name="l00518"></a><a class="code" href="ramscanner__collect_8h.html#ab5dc8716f53334cd9895c210ab4c93fa">00518</a> <a class="code" href="ramscanner__collect_8c.html#ab5dc8716f53334cd9895c210ab4c93fa">inspect_processes</a>(<a class="code" href="structoptions.html">options</a> *opt)
<a name="l00519"></a>00519 {
<a name="l00520"></a>00520         <span class="keywordtype">char</span> pathbuf[PATH_MAX]; <span class="comment">/* Buffer for storing path to open files*/</span>
<a name="l00521"></a>00521         FILE *filepageflags;<span class="comment">/* file descriptor for /proc/kpageflags */</span>
<a name="l00522"></a>00522         FILE *filepagecount;<span class="comment">/* ditto for /proc/kpagecount */</span>
<a name="l00523"></a>00523         <span class="keywordtype">int</span> i;
<a name="l00524"></a>00524         <span class="keywordtype">int</span> ret;
<a name="l00525"></a>00525 
<a name="l00526"></a>00526         <span class="keywordflow">if</span> (opt-&gt;<a class="code" href="structoptions.html#a57b3831a986f49e50f1746551d7c312e">detail</a> || opt-&gt;<a class="code" href="structoptions.html#aef87d29ef02ab135ff237eb2c7b9f9a7">compactdetail</a>) {
<a name="l00527"></a>00527                 sprintf(pathbuf, <span class="stringliteral">&quot;%s/%s&quot;</span>, <a class="code" href="ramscanner__literals_8h.html#a149096b34cfc7cb6a5fefebcd953f4d5">PROC_PATH</a>, <a class="code" href="ramscanner__literals_8h.html#ac7472b1a88b7d562157ab35cf524c8bb">KPAGEFLAGS_FILENAME</a>);
<a name="l00528"></a>00528                 errno = 0;
<a name="l00529"></a>00529                 filepageflags = fopen(pathbuf, <span class="stringliteral">&quot;r&quot;</span>);
<a name="l00530"></a>00530                 <span class="keywordflow">if</span> (filepageflags == NULL) {
<a name="l00531"></a>00531                         perror(<span class="stringliteral">&quot;Error occurred opening kpageflags&quot;</span>);
<a name="l00532"></a>00532                         <a class="code" href="ramscanner__common_8c.html#a9a3df3681470f93c9cbf201fb3e62795">cleanup_and_exit</a>(EXIT_FAILURE);
<a name="l00533"></a>00533                 }
<a name="l00534"></a>00534         }
<a name="l00535"></a>00535 
<a name="l00536"></a>00536         sprintf(pathbuf, <span class="stringliteral">&quot;%s/%s&quot;</span>, <a class="code" href="ramscanner__literals_8h.html#a149096b34cfc7cb6a5fefebcd953f4d5">PROC_PATH</a>, <a class="code" href="ramscanner__literals_8h.html#a6dabe4fcade36fb0f22fde58e3289a1f">KPAGECOUNT_FILENAME</a>);
<a name="l00537"></a>00537         errno = 0;
<a name="l00538"></a>00538         filepagecount = fopen(pathbuf, <span class="stringliteral">&quot;r&quot;</span>);
<a name="l00539"></a>00539         <span class="keywordflow">if</span> (filepagecount == NULL) {
<a name="l00540"></a>00540                 perror(<span class="stringliteral">&quot;Error occurred opening kpagecount&quot;</span>);
<a name="l00541"></a>00541                 <a class="code" href="ramscanner__common_8c.html#a9a3df3681470f93c9cbf201fb3e62795">cleanup_and_exit</a>(EXIT_FAILURE);
<a name="l00542"></a>00542         }
<a name="l00543"></a>00543 
<a name="l00544"></a>00544         <a class="code" href="ramscanner__collect_8c.html#abffda3486ef70acf1cd5492c3eaf585f">lookup_maps_with_PID</a>(opt-&gt;<a class="code" href="structoptions.html#a3aa35d527ad06e54e301bae6f1ffe5b2">pids</a>[0], opt,
<a name="l00545"></a>00545                              filepageflags, filepagecount);
<a name="l00546"></a>00546 
<a name="l00547"></a>00547         <span class="keywordflow">if</span> (opt-&gt;<a class="code" href="structoptions.html#aa46b832c2b73ca872baee120bb4bc755">summary</a>) {
<a name="l00548"></a>00548                 <a class="code" href="structoptions.html">options</a> opt2 = *opt;
<a name="l00549"></a>00549                 g_hash_table_foreach(opt-&gt;<a class="code" href="structoptions.html#a3f12bfa404a3402c0506d8dc52da4c4c">summarypages</a>, <a class="code" href="ramscanner__collect_8c.html#a7b7e7a2bbf9bb7ac7ffea207dd67f048">countsss</a>,
<a name="l00550"></a>00550                                      &amp;(opt-&gt;<a class="code" href="structoptions.html#a40fbf684316fd9e0819ab090506d3c19">summarystats</a>));
<a name="l00551"></a>00551 
<a name="l00552"></a>00552                 opt2.<a class="code" href="structoptions.html#aa46b832c2b73ca872baee120bb4bc755">summary</a> = 0;
<a name="l00553"></a>00553                 opt2.<a class="code" href="structoptions.html#a57b3831a986f49e50f1746551d7c312e">detail</a> = 0;
<a name="l00554"></a>00554                 opt2.<a class="code" href="structoptions.html#aef87d29ef02ab135ff237eb2c7b9f9a7">compactdetail</a> = 0;
<a name="l00555"></a>00555                 <span class="keywordflow">for</span> (i = 1; i &lt; opt-&gt;<a class="code" href="structoptions.html#af48db6b2a8fd988837b4b2e9d4d31a61">pidcount</a>; i++) {
<a name="l00556"></a>00556                         <a class="code" href="ramscanner__collect_8c.html#abffda3486ef70acf1cd5492c3eaf585f">lookup_maps_with_PID</a>(opt-&gt;<a class="code" href="structoptions.html#a3aa35d527ad06e54e301bae6f1ffe5b2">pids</a>[i], &amp;opt2,
<a name="l00557"></a>00557                                              filepageflags,
<a name="l00558"></a>00558                                              filepagecount);            
<a name="l00559"></a>00559                 }
<a name="l00560"></a>00560 
<a name="l00561"></a>00561                 g_hash_table_foreach(opt-&gt;<a class="code" href="structoptions.html#a3f12bfa404a3402c0506d8dc52da4c4c">summarypages</a>, <a class="code" href="ramscanner__collect_8c.html#afb500da45a8a85f07f223decbde00f22">countgss</a>,
<a name="l00562"></a>00562                                      &amp;(opt-&gt;<a class="code" href="structoptions.html#a40fbf684316fd9e0819ab090506d3c19">summarystats</a>));
<a name="l00563"></a>00563                 <a class="code" href="ramscanner__collect_8c.html#a51f3b3a2fe684b082ef2d5190a125df7">lookup_smaps</a>(opt-&gt;<a class="code" href="structoptions.html#a3aa35d527ad06e54e301bae6f1ffe5b2">pids</a>[0], &amp;(opt-&gt;<a class="code" href="structoptions.html#a40fbf684316fd9e0819ab090506d3c19">summarystats</a>));
<a name="l00564"></a>00564 
<a name="l00565"></a>00565         }
<a name="l00566"></a>00566         <span class="keywordflow">if</span> (opt-&gt;<a class="code" href="structoptions.html#a57b3831a986f49e50f1746551d7c312e">detail</a> || opt-&gt;<a class="code" href="structoptions.html#aef87d29ef02ab135ff237eb2c7b9f9a7">compactdetail</a>) {
<a name="l00567"></a>00567                 errno = 0;
<a name="l00568"></a>00568                 ret = fclose(filepageflags);
<a name="l00569"></a>00569                 <span class="keywordflow">if</span> (ret == EOF) {
<a name="l00570"></a>00570                         perror(<span class="stringliteral">&quot;Error closing kpageflags file&quot;</span>);
<a name="l00571"></a>00571                         errno = 0;
<a name="l00572"></a>00572                 }
<a name="l00573"></a>00573         }
<a name="l00574"></a>00574         errno = 0;
<a name="l00575"></a>00575         ret = fclose(filepagecount);
<a name="l00576"></a>00576         <span class="keywordflow">if</span> (ret == EOF) {
<a name="l00577"></a>00577                 perror(<span class="stringliteral">&quot;Error closing kpagecount file&quot;</span>);
<a name="l00578"></a>00578                 errno = 0;
<a name="l00579"></a>00579         }
<a name="l00580"></a>00580 }
<a name="l00581"></a>00581 
</pre></div></div>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Thu Mar 1 2012 13:27:38 for Ramscanner by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </small></address>
</body>
</html>
